<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twin Palms - New York</title>
    <meta name="description" content="Capsule One - West Village, NYC">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <!-- Process Polyfill for Framer Motion -->
    <script>
        window.process = { env: { NODE_ENV: 'production' } };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600&display=swap');
        body { font-family: 'Inter', sans-serif; }
        html { scroll-behavior: smooth; }
    </style>

    <!-- Vercel Web Analytics -->
    <script>
        window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
    </script>
    <script defer src="/_vercel/insights/script.js"></script>
</head>
<body class="bg-[#F2F0E9] overflow-hidden">
    <div id="root"></div>

    <!-- Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.3.1",
            "react-dom/client": "https://esm.sh/react-dom@18.3.1/client",
            "framer-motion": "https://esm.sh/framer-motion@10.16.4?external=react,react-dom"
        }
    }
    </script>

    <!-- Application Code -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { motion, AnimatePresence, useMotionValue, useTransform, useSpring } from 'framer-motion';

        // --- CONFIGURATION ---
        
        // 1. OWNER NOTIFICATION (FormSubmit.co)
        // ENTER YOUR EMAIL HERE to get notified when someone signs up
        const OWNER_EMAIL_FOR_NOTIFY = "twinpalmsbiz@gmail.com";

        // 2. USER CONFIRMATION (EmailJS)
        // Your keys are pre-filled based on our conversation
        const EMAILJS_SERVICE_ID = "service_gk1r5xq";
        const EMAILJS_TEMPLATE_ID = "template_7vek7jx";
        const EMAILJS_PUBLIC_KEY = "5wF7EacHGoNSA6-17";

        // --- Icons ---
        const ArrowRight = ({ size = 24, strokeWidth = 2, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M5 12h14" /><path d="m12 5 7 7-7 7" /></svg>
        );
        const Check = ({ size = 24, strokeWidth = 2, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20 6 9 17l-5-5" /></svg>
        );
        const Plus = ({ size = 24, strokeWidth = 2, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M5 12h14" /><path d="M12 5v14" /></svg>
        );

        // --- Visual Components ---
        const GrainOverlay = () => (
            <div className="fixed inset-0 pointer-events-none opacity-[0.08] mix-blend-multiply z-40">
                <svg className='w-full h-full'>
                    <filter id='noiseFilter'><feTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='3' stitchTiles='stitch'/></filter>
                    <rect width='100%' height='100%' filter='url(#noiseFilter)'/>
                </svg>
            </div>
        );

        const SkylineAssemblage = ({ mouseX, mouseY }) => {
            const moveX = useSpring(useTransform(mouseX, [0, window.innerWidth], [-20, 20]), { stiffness: 30, damping: 30 });
            const moveY = useSpring(useTransform(mouseY, [0, window.innerHeight], [-10, 10]), { stiffness: 30, damping: 30 });
            const skew = useSpring(useTransform(mouseX, [0, window.innerWidth], [-1, 1]), { stiffness: 20, damping: 30 });
            const lines = Array.from({ length: 45 });

            return (
                <motion.div style={{ x: moveX, y: moveY, skewX: skew }} className="absolute bottom-0 left-0 right-0 h-[85vh] pointer-events-none z-0 flex justify-center items-end overflow-hidden">
                    <svg viewBox="0 0 100 60" className="w-full h-full md:w-[80%] max-w-[1200px]" preserveAspectRatio="none">
                        {lines.map((_, i) => {
                            const x = (i / lines.length) * 100;
                            let height = 10;
                            if (x < 20) height = 15 + Math.sin(x) * 5;
                            else if (x >= 20 && x < 40) height = 30 + (x - 20) * 1.5; 
                            else if (x >= 40 && x < 45) height = 20;
                            else if (x >= 45 && x < 75) x < 60 ? height = 50 + (x - 45) * 2 : height = 80 - (x - 60) * 3;
                            else height = 35 - (x - 75) * 0.5;
                            height += Math.random() * 2;
                            return (
                                <motion.line key={i} x1={x + "%"} y1="100%" x2={x + "%"} y2={100 - height + "%"}
                                    initial={{ pathLength: 0, opacity: 0 }}
                                    animate={{ pathLength: 1, opacity: [0, 0.4, 0.8] }}
                                    transition={{ duration: 2.5, delay: i * 0.05 + 0.5, ease: "easeInOut" }}
                                    stroke="url(#skylineGradient)" strokeWidth="0.3" strokeLinecap="square"
                                />
                            );
                        })}
                        <defs>
                            <linearGradient id="skylineGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" stopColor="#292524" stopOpacity="0.8" />
                                <stop offset="60%" stopColor="#78716c" stopOpacity="0.4" />
                                <stop offset="100%" stopColor="#F2F0E9" stopOpacity="0" />
                            </linearGradient>
                        </defs>
                    </svg>
                </motion.div>
            );
        };

        const Rotating3DLogo = () => {
            const size = 180, halfSize = size / 2, midSize = 100, midHalf = midSize / 2, innerSize = 40, innerHalf = innerSize / 2;
            const faces = (s) => [
                { r: 'rotateY(0deg)', t: `translateZ(${s}px)` }, { r: 'rotateY(180deg)', t: `translateZ(${s}px)` },
                { r: 'rotateX(90deg)', t: `translateZ(${s}px)` }, { r: 'rotateX(-90deg)', t: `translateZ(${s}px)` },
                { r: 'rotateY(90deg)', t: `translateZ(${s}px)` }, { r: 'rotateY(-90deg)', t: `translateZ(${s}px)` }
            ];
            return (
                <div className="w-[180px] h-[180px] mx-auto mb-20 [perspective:1200px] z-20 relative">
                    <motion.div className="w-full h-full relative [transform-style:preserve-3d]" style={{ rotateY: 30 }} animate={{ rotateX: -360 }} transition={{ duration: 20, ease: "linear", repeat: Infinity }}>
                        {faces(halfSize).map((f, i) => (
                            <div key={`o-${i}`} className="absolute inset-0 border border-[#292524]/20 bg-[#F2F0E9]/5" style={{ transform: `${f.r} ${f.t}` }}>
                                <div className="absolute inset-0 bg-[linear-gradient(45deg,transparent_49%,rgba(41,37,36,0.15)_50%,transparent_51%)]" />
                                <div className="absolute top-0 left-0 w-6 h-6 border-t-2 border-l-2 border-[#292524]" />
                                <div className="absolute bottom-0 right-0 w-6 h-6 border-b-2 border-r-2 border-[#292524]" />
                            </div>
                        ))}
                        <div className="absolute top-1/2 left-1/2 w-[100px] h-[100px] -ml-[50px] -mt-[50px] [transform-style:preserve-3d]">
                             <motion.div className="w-full h-full relative [transform-style:preserve-3d]" animate={{ rotateY: 360, rotateZ: -360 }} transition={{ duration: 15, ease: "linear", repeat: Infinity }}>
                                {faces(midHalf).map((f, i) => (
                                    <div key={`m-${i}`} className="absolute inset-0 border border-[#292524]/40" style={{ transform: `${f.r} ${f.t}` }}>
                                         <div className="absolute top-1/2 left-0 w-2 h-2 bg-[#292524] -translate-x-1/2 -translate-y-1/2" />
                                         <div className="absolute top-1/2 right-0 w-2 h-2 bg-[#292524] translate-x-1/2 -translate-y-1/2" />
                                    </div>
                                ))}
                             </motion.div>
                        </div>
                        <div className="absolute top-1/2 left-1/2 w-[40px] h-[40px] -ml-[20px] -mt-[20px] [transform-style:preserve-3d]">
                            <motion.div className="w-full h-full relative [transform-style:preserve-3d]" animate={{ rotateX: 360, rotateY: 360 }} transition={{ duration: 5, ease: "linear", repeat: Infinity }}>
                                {faces(innerHalf).map((f, i) => (
                                    <div key={`i-${i}`} className="absolute inset-0 bg-[#292524] border border-[#78716c]" style={{ transform: `${f.r} ${f.t}` }}>
                                         <div className="absolute inset-2 border border-[#F2F0E9]/30" />
                                    </div>
                                ))}
                                <div className="absolute top-1/2 left-1/2 h-[140px] w-[2px] bg-[#292524] -translate-x-1/2 -translate-y-1/2 transform -translate-x-1/2 -translate-y-1/2" />
                                <div className="absolute top-1/2 left-1/2 w-[140px] h-[2px] bg-[#292524] -translate-x-1/2 -translate-y-1/2 transform -translate-x-1/2 -translate-y-1/2" />
                            </motion.div>
                        </div>
                    </motion.div>
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const [email, setEmail] = useState('');
            const [viewState, setViewState] = useState('intro');
            const [isLoading, setIsLoading] = useState(false);
            const mouseX = useMotionValue(0);
            const mouseY = useMotionValue(0);

            const handleMouseMove = (e) => { mouseX.set(e.clientX); mouseY.set(e.clientY); };

            useEffect(() => {
                // 1. Spam Protection: Check if this browser has already signed up
                // This uses Local Storage to remember the user
                const hasJoined = localStorage.getItem('twin_palms_waitlist_joined');
                if (hasJoined) {
                    setViewState('success');
                }

                // 2. Initialize EmailJS
                if(window.emailjs && EMAILJS_PUBLIC_KEY) {
                    try { window.emailjs.init(EMAILJS_PUBLIC_KEY); } catch(e) {}
                }
            }, []);

            // --- HYBRID HANDLING LOGIC ---
            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!email) return;

                if (!window.emailjs) {
                    alert("System Error: Email service failed to load. Please check your ad blocker or internet connection.");
                    return;
                }
                
                if(OWNER_EMAIL_FOR_NOTIFY === "YOUR_EMAIL_ADDRESS") {
                    alert("Setup Error: Please enter YOUR email address in the code where it says OWNER_EMAIL_FOR_NOTIFY.");
                    return;
                }

                setIsLoading(true);

                try {
                    // --- TASK 1: NOTIFY OWNER (via FormSubmit.co) ---
                    // We use fetch so it happens in the background
                    const notifyOwner = fetch(`https://formsubmit.co/ajax/${OWNER_EMAIL_FOR_NOTIFY}`, {
                        method: "POST",
                        headers: { 
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({ 
                            email: email, // The signer's email
                            message: "New Waitlist Signup from Twin Palms Site",
                            _subject: "Twin Palms: New Waitlist Entry",
                            _captcha: "false" // Disable captcha for cleaner flow
                        })
                    });

                    // --- TASK 2: CONFIRM TO USER (via EmailJS) ---
                    // This sends the pretty template
                    const confirmUser = window.emailjs.send(
                        EMAILJS_SERVICE_ID,
                        EMAILJS_TEMPLATE_ID,
                        { 
                            to_email: email,      
                            reply_to: email,      
                            message: "New signup" 
                        },
                        EMAILJS_PUBLIC_KEY
                    );

                    // Wait for both to finish (or fail)
                    // We use Promise.allSettled so one failure doesn't stop the other
                    await Promise.allSettled([notifyOwner, confirmUser]);

                    // Mark device as registered to prevent spam
                    localStorage.setItem('twin_palms_waitlist_joined', 'true');

                    // Success state
                    setViewState('success');
                    setEmail('');

                } catch (error) {
                    console.error("Submission Error:", error);
                    alert("Something went wrong. Please try again.");
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="relative w-full h-screen bg-[#F2F0E9] text-[#292524] overflow-hidden font-sans selection:bg-[#292524] selection:text-[#F2F0E9]" onMouseMove={handleMouseMove}>
                    <GrainOverlay />
                    <div className="absolute inset-0 bg-gradient-to-b from-transparent via-transparent to-[#e6e4dc] z-0 pointer-events-none" />
                    <SkylineAssemblage mouseX={mouseX} mouseY={mouseY} />

                    <div className="relative z-10 w-full h-full flex flex-col items-center justify-center px-6 pt-10">
                        <motion.div initial={{ opacity: 0, scale: 0.9 }} animate={{ opacity: 1, scale: 1 }} transition={{ duration: 1.5, ease: "easeOut" }} className="text-center w-full max-w-2xl">
                            <Rotating3DLogo />
                            <motion.p initial={{ opacity: 0 }} animate={{ opacity: 0.6 }} transition={{ delay: 1.2, duration: 1 }} className="text-xs md:text-sm tracking-[0.3em] uppercase text-[#57534e] font-medium mb-12">
                            &middot; Capsule One &middot; Coming Soon &middot;
                            </motion.p>
                        </motion.div>

                        <div className="w-full max-w-md relative h-32 flex items-start justify-center">
                            <AnimatePresence mode='wait'>
                                {viewState === 'intro' && (
                                    <motion.button key="intro-btn" initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: 10, filter: "blur(5px)" }} whileHover={{ scale: 1.02 }} whileTap={{ scale: 0.98 }} onClick={() => setViewState('form')} className="group relative px-12 py-5 bg-[#292524] text-[#F2F0E9] uppercase tracking-[0.2em] text-xs transition-all duration-500 shadow-xl shadow-[#292524]/10 hover:shadow-[#292524]/20">
                                        <span className="relative z-10 flex items-center gap-4">Join the Waitlist <Plus size={12} className="text-[#F2F0E9]/60 group-hover:text-[#F2F0E9] transition-colors" /></span>
                                    </motion.button>
                                )}

                                {viewState === 'form' && (
                                    <motion.form key="form" initial={{ opacity: 0, width: "60%" }} animate={{ opacity: 1, width: "100%" }} exit={{ opacity: 0, scale: 0.95, filter: "blur(5px)" }} transition={{ duration: 0.6, ease: [0.22, 1, 0.36, 1] }} onSubmit={handleSubmit} className="flex flex-col group relative w-full">
                                        <div className="relative flex items-center">
                                            <motion.input autoFocus type="email" required placeholder="E-mail Address" value={email} onChange={(e) => setEmail(e.target.value)} disabled={isLoading} className="w-full bg-transparent border-b border-[#a8a29e] py-4 text-center text-xl font-light tracking-wide text-[#292524] placeholder-[#a8a29e]/70 focus:outline-none focus:border-[#292524] transition-all duration-500 disabled:opacity-50 rounded-none" />
                                            <motion.button initial={{ opacity: 0, x: -10 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.2 }} whileHover={{ scale: 1.1, x: 5 }} whileTap={{ scale: 0.95 }} type="submit" disabled={isLoading || !email} className="absolute right-0 p-2 text-[#78716c] hover:text-[#292524] disabled:opacity-0 transition-all duration-300">
                                                {isLoading ? ( <motion.div animate={{ rotate: 360 }} transition={{ duration: 1, repeat: Infinity, ease: "linear" }} className="w-5 h-5 border-t border-[#292524] rounded-full" /> ) : ( <ArrowRight size={24} strokeWidth={1} /> )}
                                            </motion.button>
                                        </div>
                                    </motion.form>
                                )}

                                {viewState === 'success' && (
                                    <motion.div key="success" initial={{ opacity: 0, scale: 0.95 }} animate={{ opacity: 1, scale: 1 }} exit={{ opacity: 0 }} className="text-center w-full">
                                        <div className="flex flex-col items-center gap-3">
                                            <Check size={24} className="text-[#292524]" strokeWidth={1} />
                                            <span className="text-sm tracking-[0.2em] text-[#292524] uppercase border-b border-[#292524] pb-1">Registered</span>
                                            <p className="text-[#78716c] text-[10px] tracking-widest mt-2">Check your email for confirmation.</p>
                                        </div>
                                    </motion.div>
                                )}
                            </AnimatePresence>
                        </div>
                    </div>

                    <motion.footer initial={{ opacity: 0 }} animate={{ opacity: 1 }} transition={{ delay: 2, duration: 1 }} className="absolute bottom-10 w-full flex justify-between px-8 md:px-12 text-[10px] tracking-[0.2em] uppercase text-[#78716c] z-10 font-semibold mix-blend-multiply">
                        <span>TWIN PALMS</span><span className="hidden md:inline">West Village, NYC</span><span>Est. 2016</span>
                    </motion.footer>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
